@model AppView.Areas.Admin.ViewModels.GiamGiaCreateVM

<h2>Tạo giảm giá</h2>

<form asp-area="Admin" asp-controller="GiamGia" asp-action="Create" method="post">
    <div asp-validation-summary="All" class="text-danger"></div>

    <!-- Thông tin giảm giá -->
    <div class="form-group">
        <label asp-for="GiamGia.TenGiamGia"></label>
        <input asp-for="GiamGia.TenGiamGia" class="form-control" />
        <span asp-validation-for="GiamGia.TenGiamGia" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="GiamGia.LoaiGiamGia">Loại giảm giá</label>
        <select asp-for="GiamGia.LoaiGiamGia" class="form-control">
            <option value="">-- Chọn loại giảm giá --</option>
            <option value="PhanTram">Phần trăm</option>
            <option value="SoTien">Số tiền</option>
        </select>
    </div>

    <div class="form-group">
        <label asp-for="GiamGia.GiaTri"></label>
        <input asp-for="GiamGia.GiaTri" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="GiamGia.GiaTriGiamToiDa"></label>
        <input asp-for="GiamGia.GiaTriGiamToiDa" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="GiamGia.NgayBatDau"></label>
        <input asp-for="GiamGia.NgayBatDau" type="date" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="GiamGia.NgayKetThuc"></label>
        <input asp-for="GiamGia.NgayKetThuc" type="date" class="form-control" />
    </div>

    <hr />

    <!-- Phạm vi áp dụng -->
    <div class="form-group">
        <label class="font-weight-bold">Phạm vi áp dụng</label><br />
        <label><input type="radio" name="scope" value="dm"> Danh mục</label>
        <label><input type="radio" name="scope" value="sp" checked> Sản phẩm</label>
        <label><input type="radio" name="scope" value="spct"> Sản phẩm chi tiết</label>
    </div>

    <!-- Danh mục -->
    <div class="form-group scope-block" id="block-dm">
        <label>Danh mục</label>
        <select asp-for="SelectedDanhMucs" class="form-control" multiple>
            @foreach (var dm in Model.DanhMucs)
            {
                <option value="@dm.DanhMucId">@dm.TenDanhMuc</option>
            }
        </select>
    </div>

    <!-- Sản phẩm -->
    <div class="form-group scope-block" id="block-sp">
        <label>Sản phẩm</label>
        <select asp-for="SelectedSanPhams" class="form-control" multiple id="SanPhamSelect">
            @foreach (var sp in Model.SanPhams)
            {
                <option value="@sp.IDSanPham">@sp.TenSanPham</option>
            }
        </select>
    </div>

    <!-- SPCT -->
    <div class="form-group scope-block" id="block-spct">
        <label>Sản phẩm chi tiết</label>
        <select asp-for="SelectedSPCTs" class="form-control" multiple id="SPCTSelect"></select>
    </div>

    <input type="submit" value="Lưu" class="btn btn-primary" />
</form>

@section Scripts {
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(function () {
            const $sp = $('#SanPhamSelect');
            const $spct = $('#SPCTSelect');
            const allSPCTs = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SPCTs));

            // Init select2
            $('select').select2({ width: '100%', allowClear: true });

            // Fill SPCT theo SP
            function fillSPCTBySP(spIds) {
                $spct.empty();
                allSPCTs
                    .filter(x => spIds.includes(x.IDSanPham.toString()))
                    .forEach(x => {
                        $spct.append(new Option(
                            `${x.TenSanPham} - Size: ${x.Size ?? ""} / Màu: ${x.MauSac ?? ""} (Giá: ${x.GiaBan})`,
                            x.IDSanPhamCT
                        ));
                    });
                $spct.trigger('change');
            }

            // Fill toàn bộ SPCT
            function fillAllSPCT() {
                $spct.empty();
                allSPCTs.forEach(x => {
                    $spct.append(new Option(
                        `${x.TenSanPham} - Size: ${x.Size ?? ""} / Màu: ${x.MauSac ?? ""} (Giá: ${x.GiaBan})`,
                        x.IDSanPhamCT
                    ));
                });
                $spct.trigger('change');
            }

            // Chọn phạm vi
            $('input[name="scope"]').on('change', function () {
                const val = $(this).val();

                // Ẩn tất cả
                $(".scope-block").hide();
                // Clear tất cả select
                $("#block-dm select").val(null).trigger('change');
                $("#block-sp select").val(null).trigger('change');
                $("#block-spct select").val(null).trigger('change');

                if (val === 'dm') {
                    $("#block-dm").show();
                }
                else if (val === 'sp') {
                    $("#block-sp").show();
                }
                else if (val === 'spct') {
                    $("#block-spct").show();
                    fillAllSPCT();
                }
            });

            // Khi chọn SP → load SPCT (chỉ để hiển thị tham khảo, không gửi nếu scope=sp)
            $sp.on('change', function () {
                if ($('input[name="scope"]:checked').val() === 'sp') {
                    fillSPCTBySP($sp.val() || []);
                }
            });

            // Mặc định = sản phẩm
            $('input[name="scope"][value="sp"]').trigger('change');
        });
    </script>
}
